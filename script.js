const yoKaiList = [
    { name: "Deslumbrella", img: "deslumbrella.png" },
    { name: "Rechinella", img: "rechinella.png" },
    { name: "Esquelebella", img: "esquelebella.png" },
    { name: "Ningarra", img: "ningarra.png" },
    { name: "Habilgarra", img: "habilgarra.png" },
    { name: "Cantigarra", img: "cantigarra.png" },
    { name: "Escanlofrío", img: "escanlofrio.png" },
    { name: "Frihuahua", img: "frihuahua.png" },
    { name: "Lavadenco", img: "lavadenco.png" },
    { name: "Jibanyan", img: "jibanyan.png" },
    { name: "Espinyan", img: "espinyan.png" },
    { name: "Pelochnyan", img: "pelochnyan.png" },
    { name: "Kappandante", img: "kappandante.png" },
    { name: "Kappadachín", img: "kappadachin.png" },
    { name: "Kapparfista", img: "kapparfista.png" },
    { name: "Komasan", img: "komasan.png" },
    { name: "Komaleón", img: "komaleon.png" },
    { name: "Komajiro", img: "komajiro.png" },
    { name: "Komatigrado", img: "komatigrado.png" },
    { name: "Baku", img: "baku.png" },
    { name: "Blanpir", img: "blanpir.png" },
    { name: "Pufipatitas", img: "pufipatitas.png" },
    { name: "Pufilindo", img: "pufilindo.png" },
    { name: "Pufimaloso", img: "pufimaloso.png" },
    { name: "Fristina", img: "fristina.png" },
    { name: "Granizia", img: "granizia.png" },
    { name: "Dámona", img: "damona.png" },
    { name: "Zafinyan", img: "zafinyan.png" },
    { name: "Esmenyan", img: "esmenyan.png" },
    { name: "Rubinyan", img: "rubinyan.png" },
    { name: "Topanyan", img: "topanyan.png" },
    { name: "Diamanyan", img: "diamanyan.png" },
    { name: "Patis", img: "Patis.png" },
    { name: "Picassina", img: "Picassina.png" },
    { name: "Chíclope", img: "Chiclope.png" },
    { name: "Buchinyan", img: "Buchinyan.png" },
    { name: "Somnia", img: "Somnia.png" },
    { name: "Cellisca", img: "Cellisca.png" },
    { name: "Rapidizo", img: "Rapidizo.png" },
    { name: "Oso Boco", img: "Oso_Boco.png" },
    { name: "Kappafalso", img: "Kappafalso.png" },
    { name: "Tigrappa", img: "Tigrappa.png" },
    { name: "Gran Mangu", img: "Gran_Mangu.png" },
    { name: "Chafarina", img: "Chafarina.png" },
    { name: "Melonyan", img: "Melonyan.png" },
    { name: "Naranyan", img: "Naranyan.png" },
    { name: "Kiwinyan", img: "Kiwinyan.png" },
    { name: "Uvanyan", img: "Uvanyan.png" },
    { name: "Fresanyan", img: "Fresanyan.png" },
    { name: "Sandinyan", img: "Sandinyan.png" },
    { name: "Robokapp", img: "Robokapp.png" },
    { name: "Robokoma", img: "Robokoma.png" },
    { name: "Maravinyan", img: "Maravinyan.png" },
    { name: "Sailornyan", img: "Sailornyan.png" },
    { name: "Jibakoma", img: "Jibakoma.png" },
    { name: "Jetnyan", img: "Jetnyan.png" },
    { name: "Pupilo Panja", img: "Pupilo_Panja.png" },
    { name: "Panja Pro", img: "Panja_Pro.png" },
    { name: "Jibanyan S", img: "Jibanyan_S.png" },
    { name: "Komasan S", img: "Komasan_S.png" },
    { name: "Komajiro S", img: "Komajiro_S.png" },
    { name: "Pelirrojo", "img": "Pelirrojo.png" },
  { name: "Grazi", "img": "Grazi.png" },
  { name: "Jibanyan B", "img": "Jibanyan_B.png" },
  { name: "Komasan B", "img": "Komasan_B.png" },
  { name: "Simionyan", "img": "Simionyan.png" },
  { name: "Rúbeo J", "img": "Rubeo_J_A.png" },
  { name: "Gran Sabueso", "img": "Gran_Sabueso_A.png" },
  { name: "Sincopollo", "img": "Sincopollo.png" },
  { name: "Brownilda", "img": "Brownilda.png" },
  { name: "Chapulín", "img": "Chapulin.png" },
  { name: "Apalneado", "img": "Apanleado.png" },
  { name: "Panduro", "img": "Panduro.png" },
  { name: "Superniñato", "img": "Superninato.png" },
  { name: "Superniñato Rebelde", "img": "Superninato_Rebelde.png" },
  { name: "Superniñato Picajoso", "img": "Superninato_Picajoso.png" },
  { name: "BellónZ", "img": "BellonZ.png" },
  { name: "Olvirunner", "img": "Olvirunner.png" },
  { name: "Gatallanes", "img": "Gatallanes.png" },
  { name: "Limonescente", "img": "Limonescente.png" },
  { name: "Tomanota", "img": "Tomanota.png" },
  { name: "Zalameria", "img": "Zalameria.png" },
  { name: "Jibanyan Liu Bei", "img": "Jibanyan_Liu_Bei.png" },
  { name: "Komasan Sun Ce", "img": "Komasan_Sun_Ce.png" },
  { name: "Todoapesta", "img": "Todoapesta.png" },
  { name: "Relapache", "img": "Relapache.png" },
  { name: "Cafechucho", "img": "Cafechucho.png" },
  { name: "Partidacio", "img": "Partidacio.png" },
  { name: "Tomnyan", "img": "Tomnyan.png" },
  { name: "Komaestopistas", "img": "Komaestopistas.png" },
  { name: "Segadora", "img": "Segadora.png" },
  { name: "Chocobonyan", "img": "Chocobonyan.png" },
  { name: "Mogurinyan", "img": "Mogurinyan.png" },
  { name: "Wobblenyan", "img": "Wobblenyan.png" },
  { name: "Wibblekoma", "img": "Wibblekoma.png" },
  { name: "Sushinyan", "img": "Sushinyan.png" },
  { name: "Tempurasan", "img": "Tempurasan.png" },
  { name: "Tenguriginal", "img": "Tenguriginal.png" },
  { name: "Ángel Garudián", "img": "Angel_Garudian.png" },
  { name: "Originyan", "img": "originyan.png" },
  { name: "Rey Jibanyan", "img": "Rey_Jibanyan.png" },
  { name: "Jotamasan", "img": "Jotamasan.png" },
  { name: "Diez de Komajiro", "img": "Diez_de_Komajiro.png" },
  { name: "Benzaiten", "img": "Benzaiten.png" },
  { name: "Divamarina", "img": "Divamarina.png" },
  { name: "Topiña", "img": "Topina.png" },
  { name: "Miss Mousse", "img": "Miss_Mousse.png" },
  { name: "Populina", "img": "populina.gif" },
  { name: "Koalanyan", "img": "Koalanyan.png" },
  { name: "Jibanyan T", "img": "jibanyan_T.gif" },
  { name: "Komasan T", "img": "komasan_T.gif" },
  { name: "Yemajestad", "img": "Yemajestad.png" },
  { name: "Ciclomán", "img": "Cicloman.png" },
  { name: "Pandora", "img": "Pandora.png" },
  { name: "Discursi", "img": "Discursi.png" },
  { name: "Cimbalina", "img": "Cimbalina.png" },
  { name: "KJ", "img": "KJ.png" },
  { name: "Miopatra", "img": "Miopatra.png" },
    { name: "Wibblejiro", aliases: ["Wibblejiro", "Wobblejiro", "Punijiro"], img: "Wibblejiro.png" },
    { name: "Jibanyan T G", aliases: ["Jibanyan T G", "T-Jibanyan G"], img: "Jibanyan_T_G.png" },
    { name: "Jibanyan D", img: "Jibanyan_D.png" },
    { name: "Komasan T G", aliases: ["Komasan T G", "T-Komasan G"], img: "Komasan_T_G.png" },
    { name: "Komasan D", img: "Komasan_D.png" },
    { name: "Armaterasu", aliases: ["Armaterasu", "Armorterasu", "Amaterasu"], img: "Armaterasu.png" },
    { name: "Kirene", img: "Kirene.png" },
    { name: "Seirei Banbarayar", img: "Seirei_Banbarayar.png" },
];

let score = 0; 
let gameEnded = false; // Evita cambios una vez terminado el juego
const unlockedYoKai = new Set(); // Registro de Yo-kai desbloqueados por índice

// Normalizar la entrada del usuario (sin tildes y en minúsculas)
function normalizeString(str) {
    return str.normalize("NFD").replace(/[̀-\u036f]/g, "").toLowerCase();
}

// Crear el objeto de audio una sola vez
let getSound = new Audio("get.mp3");

// Reproducir sonido cuando se desbloquea un Yo-kai (sin solapamiento)
function playGetSound() {
    if (!getSound.paused) {
        getSound.pause(); // Detener el sonido actual si ya está reproduciéndose
        getSound.currentTime = 0; // Reiniciar el sonido al principio
    }
    getSound.play(); // Reproducir el sonido
}

// Actualizar la puntuación en formato (adivinados / totales)
function updateScoreDisplay() {
    const scoreDisplay = document.getElementById("score");
    scoreDisplay.textContent = `${score}/${yoKaiList.length}`;
}

// Verificar la respuesta del usuario
function checkAnswer() {
    if (gameEnded) return; // Si el juego ha terminado, no hacer nada

    const userAnswer = normalizeString(document.getElementById("answer-input").value.trim());

    let correctGuess = false; // Bandera para reproducir el sonido solo si hay aciertos

    yoKaiList.forEach((yoKai, index) => {
        // Normaliza todos los nombres asociados al Yo-kai
        const normalizedNames = [yoKai.name, ...(yoKai.aliases || [])].map(name => normalizeString(name));

        // Si la respuesta coincide con alguno de los nombres y no ha sido desbloqueado
        if (normalizedNames.includes(userAnswer) && !unlockedYoKai.has(index)) {
            const yoKaiImg = document.getElementById(`yo-kai${index + 1}`);
            if (yoKaiImg && yoKaiImg.src.includes("no-kai.png")) {
                yoKaiImg.src = yoKai.img; // Actualiza la imagen

                // Añadir clase para animación
                yoKaiImg.classList.add("yokai-unlocked");
                yoKaiImg.addEventListener("animationend", () => {
                    yoKaiImg.classList.remove("yokai-unlocked"); // Quitar clase tras animación
                });

                unlockedYoKai.add(index); // Marcar el Yo-kai como desbloqueado
                score++;
                correctGuess = true; // Se encontró un acierto
            }
        }
    });

    if (correctGuess) {
        playGetSound(); // Reproducir sonido solo si hubo un acierto
        updateScoreDisplay(); // Actualizar puntuación
        document.getElementById("answer-input").value = ""; // Borra la respuesta después de un acierto
    }

    checkGameEnd(); // Verifica si el juego ha terminado
}

// Verificar si el juego ha terminado (cuando se han adivinado todos los Yo-kai)
function checkGameEnd() {
    if (score === yoKaiList.length) {
        gameEnded = true;
        stopTimer(); // Detener el temporizador
        showCongratsImage(); // Mostrar imagen de "¡Felicidades!"
    }
}

function showCongratsImage() {

    // Detener temporizador
    stopTimer();

    // Obtener tiempo final mostrado
    const tiempoTotal = document.getElementById("time").textContent;

    // Sonido de victoria
    const victorySound = new Audio("congrats.mp3");
    victorySound.volume = 0.8;
    victorySound.play().catch(() => {});

    // Panel lateral
    const finalPanel = document.createElement("div");
    finalPanel.style.position = "fixed";
    finalPanel.style.top = "0";
    finalPanel.style.right = "-350px";
    finalPanel.style.width = "320px";
    finalPanel.style.height = "100%";
    finalPanel.style.backgroundColor = "#c44563";
    finalPanel.style.color = "white";
    finalPanel.style.padding = "20px";
    finalPanel.style.boxSizing = "border-box";
    finalPanel.style.zIndex = "1000";
    finalPanel.style.fontFamily = "Arial, sans-serif";
    finalPanel.style.display = "flex";
    finalPanel.style.flexDirection = "column";
    finalPanel.style.transition = "right 0.6s ease";

    // Botón cerrar
    const closeBtn = document.createElement("div");
    closeBtn.textContent = "✖";
    closeBtn.style.position = "absolute";
    closeBtn.style.top = "15px";
    closeBtn.style.right = "15px";
    closeBtn.style.cursor = "pointer";
    closeBtn.style.fontSize = "18px";

    closeBtn.addEventListener("click", () => {
        finalPanel.style.right = "-350px";
        setTimeout(() => finalPanel.remove(), 600);
    });

    // Título
    const title = document.createElement("h2");
    title.textContent = `¡Enhorabuena! Has adivinado todos los Yo-kai en ${tiempoTotal}`;
    title.style.marginTop = "40px";
    title.style.marginBottom = "30px";
    title.style.fontSize = "22px";

    // Texto Twitter
    const followText = document.createElement("p");
    followText.innerHTML = `
        Si te ha gustado, ¿por qué no seguirme en twitter?: 
        <a href="https://x.com/salty_baconV2" target="_blank" style="color:#4fc3ff; text-decoration:none;">
        @Salty_BaconV2
        </a>
    `;
    followText.style.fontSize = "16px";
    followText.style.marginTop = "auto";

    // Montaje
    finalPanel.appendChild(closeBtn);
    finalPanel.appendChild(title);
    finalPanel.appendChild(followText);
    document.body.appendChild(finalPanel);

    // Animación de entrada
    setTimeout(() => {
        finalPanel.style.right = "0";
    }, 50);
}

// Temporizador
let startTime;
let timerInterval;

function startTimer() {
    startTime = Date.now();
    timerInterval = setInterval(updateTimer, 1000);
}

function updateTimer() {
    const currentTime = Date.now();
    const elapsedTime = currentTime - startTime;

    const hours = Math.floor(elapsedTime / (1000 * 60 * 60));
    const minutes = Math.floor((elapsedTime % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((elapsedTime % (1000 * 60)) / 1000);

    const formattedTime = `${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
    document.getElementById("time").textContent = formattedTime;
}

function stopTimer() {
    clearInterval(timerInterval);
}

// Manejador de evento: validación automática con "input"
document.getElementById("answer-input").addEventListener("input", checkAnswer);

// Inicializar el marcador y temporizador al cargar la página
updateScoreDisplay(); // Inicializa la puntuación en 0/total
startTimer();

window.addEventListener("beforeunload", (event) => {
    if (score > 0) { // Mostrar advertencia solo si hay progreso
        event.preventDefault();
        event.returnValue = "¿Estás seguro de que quieres salir? Se perderá todo el progreso.";
    }
});
